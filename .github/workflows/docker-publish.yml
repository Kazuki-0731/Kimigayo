name: Docker Build and Push

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v0.1.0)'
        required: false
        default: 'latest'

env:
  DOCKER_HUB_USERNAME: ishinokazuki
  IMAGE_NAME: kimigayo-os

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [minimal, standard, extended]
        arch: [x86_64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          # Extract version from tag (remove 'v' prefix)
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.event.inputs.tag }}" != "" ]]; then
            VERSION=${{ github.event.inputs.tag }}
            VERSION=${VERSION#v}
          else
            VERSION=edge
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Set architecture for Docker
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            DOCKER_ARCH="amd64"
          else
            DOCKER_ARCH="arm64"
          fi
          echo "docker_arch=${DOCKER_ARCH}" >> $GITHUB_OUTPUT

          # Build variant-specific tags
          VARIANT=${{ matrix.variant }}
          if [[ "${VARIANT}" == "standard" ]]; then
            # Standard variant gets no suffix
            TAGS="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-${DOCKER_ARCH}"
            TAGS="${TAGS},${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-${DOCKER_ARCH}"
          else
            # Minimal and Extended get variant suffix
            TAGS="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-${VARIANT}-${DOCKER_ARCH}"
            TAGS="${TAGS},${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-${VARIANT}-${DOCKER_ARCH}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Build Kimigayo OS rootfs
        run: |
          # Set architecture environment variable
          export ARCH=${{ matrix.arch }}
          export IMAGE_TYPE=${{ matrix.variant }}

          # Build the rootfs using build script
          bash scripts/build-rootfs.sh

          # Verify output exists
          ls -lh output/

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.runtime
          platforms: linux/${{ steps.meta.outputs.docker_arch }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            org.opencontainers.image.title=Kimigayo OS
            org.opencontainers.image.description=Alpine Linux-inspired lightweight, fast, and secure container OS
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kimigayo-${{ matrix.variant }}-${{ steps.meta.outputs.version }}-${{ matrix.arch }}
          path: output/*.tar.gz
          retention-days: 30

  create-manifest:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Create and push multi-arch manifests
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}

          # Create manifests for each variant
          for VARIANT in minimal standard extended; do
            if [[ "${VARIANT}" == "standard" ]]; then
              # Standard variant (no suffix)
              docker buildx imagetools create -t ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION} \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-amd64 \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-arm64

              docker buildx imagetools create -t ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-amd64 \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-arm64
            else
              # Minimal and Extended variants
              docker buildx imagetools create -t ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-${VARIANT} \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-${VARIANT}-amd64 \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-${VARIANT}-arm64

              docker buildx imagetools create -t ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-${VARIANT} \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-${VARIANT}-amd64 \
                ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-${VARIANT}-arm64
            fi
          done
