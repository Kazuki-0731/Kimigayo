name: Scheduled Security Scan

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ åˆå‰9æ™‚ (JST) = æ—¥æ›œæ—¥ åˆå‰0æ™‚ (UTC)
    - cron: '0 0 * * 0'
  workflow_dispatch:

env:
  DOCKER_HUB_USERNAME: ishinokazuki
  IMAGE_NAME: kimigayo-os

jobs:
  scan-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        variant: [minimal, standard, extended]
        tag: [latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Docker image
        run: |
          if [[ "${{ matrix.variant }}" == "standard" ]]; then
            IMAGE_REF="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"
          else
            IMAGE_REF="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}-${{ matrix.variant }}"
          fi
          echo "IMAGE_REF=${IMAGE_REF}" >> $GITHUB_ENV
          docker pull ${IMAGE_REF}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.variant }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.variant }}.sarif'
          category: 'scheduled-scan-${{ matrix.variant }}'

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret'

      - name: Run ShellCheck on scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          ignore_paths: build output

  scan-filesystem:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret,license'

      - name: Upload filesystem scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'scheduled-scan-filesystem'

      - name: Run Trivy filesystem scan (table output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret,license'

  create-issue-on-vulnerabilities:
    needs: [scan-images, scan-filesystem]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Create issue for vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ”’ å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã§è„†å¼±æ€§ã‚’æ¤œå‡º';
            const body = `## å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ

            å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã§è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚

            **ã‚¹ã‚­ãƒ£ãƒ³æ—¥æ™‚**: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${context.workflow}
            **å®Ÿè¡ŒID**: ${context.runId}

            ### å¯¾å¿œãŒå¿…è¦ãªé …ç›®

            - [ ] GitHub Security Tabã§è©³ç´°ã‚’ç¢ºèª
            - [ ] è„†å¼±æ€§ã®å½±éŸ¿ç¯„å›²ã‚’è©•ä¾¡
            - [ ] ä¿®æ­£è¨ˆç”»ã‚’ç­–å®š
            - [ ] ãƒ‘ãƒƒãƒé©ç”¨ã¾ãŸã¯å›é¿ç­–ã®å®Ÿæ–½
            - [ ] ä¿®æ­£å¾Œã®å†ã‚¹ã‚­ãƒ£ãƒ³

            ### ãƒªãƒ³ã‚¯

            - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œè©³ç´°](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [Security Tab](${context.payload.repository.html_url}/security)

            ---
            *ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated']
            });
