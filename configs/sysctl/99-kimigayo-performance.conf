# Kimigayo OS - Kernel Performance Tuning
# コンテナ環境向けカーネルパラメータ最適化

# === メモリ管理最適化 ===

# スワップ使用を最小化（コンテナではメモリ優先）
vm.swappiness = 0

# ダーティページの書き込み閾値を調整（I/O最適化）
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5

# メモリオーバーコミットを許可（コンテナ環境）
vm.overcommit_memory = 1

# Out-of-Memory Killerの動作調整
vm.panic_on_oom = 0
vm.oom_kill_allocating_task = 0

# === ネットワーク最適化 ===

# TCP バッファサイズ最適化
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# TCP ウィンドウスケーリング
net.ipv4.tcp_window_scaling = 1

# TCP タイムスタンプ（パフォーマンス向上）
net.ipv4.tcp_timestamps = 1

# TIME_WAIT ソケットの再利用
net.ipv4.tcp_tw_reuse = 1

# SYN cookies 有効化（SYN flood 対策）
net.ipv4.tcp_syncookies = 1

# TCP キープアライブ設定（接続維持）
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes = 3

# === ファイルシステム最適化 ===

# ファイルディスクリプタ最大数
fs.file-max = 65536

# inode/dentry キャッシュ圧力調整
vm.vfs_cache_pressure = 50

# === カーネル全般 ===

# プロセス数制限
kernel.pid_max = 32768

# メッセージキュー最適化
kernel.msgmnb = 65536
kernel.msgmax = 65536

# 共有メモリ設定
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

# === セキュリティ（最小限） ===

# ASLR 有効化
kernel.randomize_va_space = 2

# コアダンプ制限（セキュリティ）
kernel.core_uses_pid = 1
fs.suid_dumpable = 0
