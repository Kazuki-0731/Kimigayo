# Kimigayo OS 設計書

## 1. プロジェクト概要

Kimigayo OSは、Googleのdistrolessと同様の設計思想を採用した軽量・高速・セキュアなコンテナ向けオペレーティングシステムです。パッケージマネージャーを意図的に排除し、不変インフラを徹底することで、最小限のリソースで動作し、コンテナ環境やマイクロサービスアーキテクチャで高いパフォーマンスとセキュリティを実現します。

## 2. 設計思想

### 2.1 コアプリンシプル
- **軽量性（Lightweight）**: 最小限のフットプリント（目標: ベースイメージ1-3MB）
- **不変性（Immutability）**: パッケージマネージャー排除による不変インフラの実現
- **セキュリティ（Security）**: 最小攻撃面を実現するセキュアバイデフォルトの設計
- **高速性（Performance）**: 高速起動と低メモリ消費
- **予測可能性（Predictability）**: ビルド時に全てが決定される予測可能な動作
- **デバッグ性（Debuggability）**: distrolessと異なり、シェルとユーティリティを含む
  - BusyBoxによる基本的なUnixコマンド
  - 本番環境でのトラブルシューティングが容易
  - コンテナ内でのデバッグ作業が可能

### 2.2 Distroless的アプローチの採用
- パッケージマネージャーの意図的な排除
- ランタイムでの変更を許さない不変インフラ
- マルチステージビルドによる依存関係管理
- 最小攻撃面によるセキュリティ強化
- コンテナファーストの思想

## 3. 主要コンポーネント

### 3.1 カーネル
- **種別**: Linuxカーネルベース（または独自マイクロカーネル）
- **構成**: モノリシックカーネルから必要なモジュールのみを選択
- **セキュリティ**: Kernel hardening（ASLR, DEP, etc.）

### 3.2 Cライブラリ
- **選択肢**: musl libc（Alpineと同様）
- **理由**: 軽量、高速、セキュア、静的リンクのサポート

### 3.3 コアユーティリティ
- **選択肢**: BusyBox（または独自実装）
- **理由**: 単一バイナリで多数のUnixコマンドを提供

### 3.4 initシステム
- **選択肢**: OpenRC（または独自軽量initシステム）
- **理由**: systemdより軽量でシンプル

### 3.5 パッケージマネージャ
- **設計方針**: パッケージマネージャーを意図的に排除（distroless的アプローチ）
- **理由**:
  - 最小攻撃面の実現
  - 不変インフラの徹底
  - マルチステージビルドでの利用を推奨

## 4. アーキテクチャ

### 4.1 システム構成

```
┌─────────────────────────────────────────┐
│         User Applications               │
├─────────────────────────────────────────┤
│    Core Utilities (BusyBox)             │
├─────────────────────────────────────────┤
│    Init System (OpenRC)                 │
├─────────────────────────────────────────┤
│    C Library (musl libc)                │
├─────────────────────────────────────────┤
│    Linux Kernel (hardened)              │
├─────────────────────────────────────────┤
│    Hardware                             │
└─────────────────────────────────────────┘
```

### 4.2 ディレクトリ構造

```
/
├── bin/          # 基本コマンド（BusyBox）
├── dev/          # デバイスファイル
├── etc/          # 設定ファイル
├── home/         # ユーザーディレクトリ
├── lib/          # 共有ライブラリ
├── mnt/          # 一時マウントポイント
├── opt/          # オプションソフトウェア
├── proc/         # プロセス情報
├── root/         # rootユーザーのホーム
├── run/          # ランタイムデータ
├── sbin/         # システム管理コマンド
├── srv/          # サービスデータ
├── sys/          # システム情報
├── tmp/          # 一時ファイル
├── usr/          # ユーザープログラム
└── var/          # 可変データ
```

## 5. セキュリティ仕様

### 5.1 コンパイル時のセキュリティ
- PIE (Position Independent Executables)
- Stack-smashing protection
- FORTIFY_SOURCE
- RELRO (Relocation Read-Only)

### 5.2 ランタイムセキュリティ
- ASLR (Address Space Layout Randomization)
- DEP (Data Execution Prevention)
- Seccomp-BPF
- Namespace isolation

### 5.3 パッケージセキュリティ
- **Ed25519署名検証（推奨）**
  - 軽量・高速な署名アルゴリズム
  - 署名長: 64バイト（128 hex文字）
  - 公開鍵長: 32バイト（64 hex文字）
  - コンテナ環境に最適
- GPG署名検証（レガシーサポート）
- ハッシュ検証（SHA-256）
- セキュリティアップデートの優先配信

## 6. ターゲット環境

### 6.1 コンテナ環境（主要ターゲット）
- Docker
- Kubernetes
- Podman

Kimigayo OSはDockerイメージとして実行されることを前提に設計されており、コンテナ環境での利用を最優先としています。

## 7. 開発ロードマップ

### Phase 1: 基礎構築（1-3ヶ月）
- [ ] ビルドシステムの構築
- [ ] カーネル設定とビルド
- [ ] musl libcの統合
- [ ] BusyBoxの統合
- [ ] initシステムの実装

### Phase 2: パッケージシステム（3-6ヶ月）
- [ ] パッケージマネージャの設計
- [ ] パッケージマネージャの実装
- [ ] ベースパッケージの作成
- [ ] リポジトリシステムの構築

### Phase 3: ツールとユーティリティ（6-9ヶ月）
- [ ] システム管理ツール
- [ ] ネットワークツール
- [ ] 開発ツール
- [ ] ドキュメント整備

### Phase 4: 最適化とテスト（9-12ヶ月）
- [ ] パフォーマンスチューニング
- [ ] セキュリティ監査
- [ ] 統合テスト
- [ ] ベータリリース

## 8. 技術仕様

### 8.1 最小システム要件
- CPU: x86_64, ARM64
- RAM: 128MB（最小）、512MB（推奨）
- Storage: 512MB（最小）、2GB（推奨）

### 8.2 サポートアーキテクチャ
- x86_64 (AMD64)
- ARM64 (AArch64)
- 将来的に: RISC-V, ARM32

### 8.3 ベースイメージサイズ目標
- Minimal: 5MB以下
- Standard: 15MB以下
- Extended: 50MB以下

## 9. ビルドシステム

### 9.1 ビルドツール
- ビルドシステム: GNU Make + shell scripts
- クロスコンパイル対応
- 再現可能なビルド

### 9.2 ビルドプロセス
1. カーネルのビルド
2. musl libcのビルド
3. BusyBoxのビルド
4. initシステムのビルド
5. ルートファイルシステムの構築
6. ISOイメージ/コンテナイメージの生成

## 10. 命名規則とブランディング

### 10.1 プロジェクト名
- **Kimigayo OS**: メインプロジェクト名
- **Kimigayo**: 短縮形

### 10.2 バージョニング
- セマンティックバージョニング（例: 1.0.0）
- メジャー.マイナー.パッチ

### 10.3 リリース名
- Alpineが月の名前を使用するように、Kimigayo OSは日本の季節や自然をテーマにする
- 例: Sakura (桜), Momiji (紅葉), Yuki (雪)

## 11. コミュニティとライセンス

### 11.1 ライセンス
- OSコア: GPLv2（Linuxカーネルに準拠）
- ユーザーランドツール: MIT/BSD/GPL（各コンポーネントによる）

### 11.2 開発モデル
- オープンソース開発
- GitHubでのコード管理
- コミュニティドリブンの開発

## 12. 差別化ポイント

### 12.1 Alpine Linuxとの違い
- より日本語ドキュメントの充実
- 東アジア圏のミラーサーバー最適化
- 独自のパッケージマネージャによる高速化
- モダンなツールチェインの積極採用

### 12.2 他のディストリビューションとの違い
- 極限まで削ぎ落とした軽量性
- コンテナ環境での最適化
- セキュリティファーストの設計
- シンプルで理解しやすいシステム構成

## 13. 今後の展望

- クラウドネイティブ環境での最適化
- Kubernetesとの統合強化
- マイクロサービスアーキテクチャへの最適化
- セキュリティ認証の取得
